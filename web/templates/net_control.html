{% extends "base.html" %}
{% block title %}Net Control{% endblock %}
{% block content %}
{% if load_error %}
<div class="alert warning">
    {{ load_error }}
</div>
{% endif %}
{% if requires_login %}
<div class="alert info">
    Please sign in to control nets. You can still review recent sessions and check-ins below.
</div>
{% endif %}
<section class="grid">
    <article>
        <h2>Manual Net Session</h2>
        {% if active_session %}
            <p class="muted">Active since {{ active_session.started_at }} • started by {{ active_session.started_by }}</p>
        {% endif %}
        {% if requires_login %}
            <p class="muted">Manual controls are limited to authenticated portal operators.</p>
        {% elif active_session %}
            <form method="post" action="/net-control/{{ active_session.id }}/stop">
                <button type="submit">Flag Net Stop</button>
            </form>
        {% else %}
            <form method="post" action="/net-control/start" class="net-control-form">
                <label for="net-name">Net name</label>
                <input id="net-name" name="name" placeholder="Thursday Traffic Net" />
                <label for="net-notes">Notes</label>
                <textarea id="net-notes" name="notes" rows="3" placeholder="Any context or repeaters"></textarea>
                <button type="submit">Flag Net Start</button>
            </form>
        {% endif %}
    </article>
    <article>
        <h2>Recent Sessions</h2>
        <ul class="health-list">
            {% if sessions %}
            {% for session in sessions %}
                <li>
                    <span>{{ session.name }} • {{ session.started_at }}</span>
                    <strong class="status {{ session.status }}">{{ session.status }}</strong>
                </li>
            {% endfor %}
            {% else %}
                <li class="muted">No manual sessions have been logged yet.</li>
            {% endif %}
        </ul>
    </article>
</section>

<section class="card">
    <div class="card-header">
        <h3>Live Check-ins & Transcripts</h3>
        <div class="chip-row">
            <button id="net-feed-refresh" data-feed-url="/api/net-control/feed">Refresh</button>
            <a class="chip" href="/api/net-control/feed?format=csv">Download CSV</a>
        </div>
    </div>
    <div class="table-wrapper">
        <table id="net-control-feed">
            <thead><tr><th>Detected At</th><th>Callsign ID</th><th>Confidence</th><th>Context</th></tr></thead>
            <tbody>
                {% if feed %}
                {% for row in feed %}
                    <tr>
                        <td>{{ row.detected_at }}</td>
                        <td>{{ callsign_link(row.callsign_id) }}</td>
                        <td>{{ row.confidence or '—' }}</td>
                        <td>{{ row.context or row.transcript }}</td>
                    </tr>
                {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" class="muted">No check-ins yet.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
