{% extends "base.html" %}
{% block title %}Net Summary · {{ net.name }}{% endblock %}
{% block content %}
<section class="card">
    <div class="card-header">
        <h2>{{ net.name }}</h2>
        <span class="muted">{{ net.start_time }} → {{ net.end_time }}</span>
    </div>
    <div class="card-body grid">
        <article>
            <h3>Overview</h3>
            <ul class="meta-list">
                <li><strong>Hosting club:</strong> {{ net.club or '—' }}</li>
                <li><strong>Net Control:</strong> {{ callsign_link(net.ncs) if net.ncs else 'Unknown' }}</li>
                <li><strong>Duration:</strong> {{ (net.duration_sec // 60) }} min</li>
                <li><strong>Participants:</strong> {{ net.participant_count }}</li>
                <li><strong>Confidence:</strong> {{ '{:.0%}'.format(net.confidence) if net.confidence is not none else '—' }}</li>
            </ul>
            
            {% if net.formal_structure %}
            <h4>Formal Structure</h4>
            {% set fs = net.formal_structure %}
            <ul class="meta-list">
                <li><strong>Opening:</strong> {{ '✓ Yes' if fs.get('has_opening') else '✗ No' }}</li>
                <li><strong>Check-ins:</strong> {{ '✓ Yes' if fs.get('has_checkins') else '✗ No' }}</li>
                <li><strong>Closing:</strong> {{ '✓ Yes' if fs.get('has_closing') else '✗ No' }}</li>
            </ul>
            {% if fs.get('opening_text') %}
            <div class="well">
                <h5>Opening Statement</h5>
                <p><em>"{{ fs.opening_text }}"</em></p>
                <span class="muted">Source: Transcript #{{ fs.opening_source }}</span>
            </div>
            {% endif %}
            {% if fs.get('closing_text') %}
            <div class="well">
                <h5>Closing Statement</h5>
                <p><em>"{{ fs.closing_text }}"</em></p>
                <span class="muted">Source: Transcript #{{ fs.closing_source }}</span>
            </div>
            {% endif %}
            {% endif %}
            
            <h4>Engagement Metrics</h4>
            <ul class="meta-list">
                <li><strong>Check-ins:</strong> {{ net.metrics.checkins }}</li>
                <li><strong>Validated:</strong> {{ net.metrics.validated_checkins }}</li>
                <li><strong>Late arrivals:</strong> {{ net.metrics.late_checkins }}</li>
                <li><strong>Relay/Proxy:</strong> {{ net.metrics.relay_checkins }}</li>
                <li><strong>Total talk:</strong> {{ net.metrics.total_talk_seconds }} s</li>
                <li><strong>Avg talk:</strong> {{ net.metrics.avg_talk_seconds }} s</li>
                <li><strong>Avg transmissions:</strong> {{ net.metrics.avg_transmissions }}</li>
            </ul>
            {% if net.summary %}
                <p>{{ net.summary }}</p>
            {% else %}
                <p class="muted">No AI summary available yet.</p>
            {% endif %}
        </article>
        <article>
            <h3>Topics</h3>
            {% if net.topics %}
                <div class="chip-row">
                    {% for topic in net.topics %}
                        <span class="chip">{{ topic }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="muted">No topics captured.</p>
            {% endif %}
            
            {% if net.ncs_script %}
            <h4>NCS Script</h4>
            <div class="well">
                <ul>
                {% for statement in net.ncs_script[:10] %}
                    <li>"{{ statement }}"</li>
                {% endfor %}
                {% if net.ncs_script|length > 10 %}
                    <li class="muted">...and {{ net.ncs_script|length - 10 }} more</li>
                {% endif %}
                </ul>
            </div>
            {% endif %}
            
            {% if net.statistics %}
                <h4>Analyzer Snapshot</h4>
                <ul class="meta-list">
                    {% for key, value in net.statistics.items() %}
                        <li><strong>{{ key|replace('_', ' ')|title }}:</strong> {{ value }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if net.source_segments %}
                <h4>Source Segments</h4>
                <ul class="meta-list">
                    {% for segment in net.source_segments %}
                        <li>
                            <strong>{{ segment.captured }}</strong>
                            <span class="muted">· {{ segment.filename }}</span>
                            <code>{{ segment.transcription_id[:8] }}</code>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </article>
    </div>
</section>

{% if net.checkin_sequence %}
<section class="card">
    <div class="card-header">
        <h3>Formal Check-in Sequence</h3>
        <span class="muted">Detected formal check-ins in order.</span>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Callsign</th>
                    <th>Time</th>
                    <th>Statement</th>
                </tr>
            </thead>
            <tbody>
                {% for checkin in net.checkin_sequence %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ callsign_link(checkin.callsign) }}</td>
                    <td>Transcript #{{ checkin.time }}</td>
                    <td><em>"{{ checkin.statement }}"</em></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<section class="card">
    <div class="card-header">
        <h3>Check-ins</h3>
        <span class="muted">Includes unverified callsigns.</span>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Callsign</th>
                    <th>Check-in Type</th>
                    <th>Transmissions</th>
                    <th>Talk Time (s)</th>
                    <th>First Seen</th>
                    <th>Last Seen</th>
                </tr>
            </thead>
            <tbody>
                {% for member in net.participants %}
                    <tr>
                        <td>
                            {{ callsign_link(member.callsign) }}
                            {% if not member.validated %}
                                <span class="chip warning">Unverified</span>
                            {% endif %}
                        </td>
                        <td>{{ member.checkin_type }}</td>
                        <td>{{ member.transmissions }}</td>
                        <td>{{ member.talk_seconds }}</td>
                        <td>{{ member.first_seen }}</td>
                        <td>{{ member.last_seen }}</td>
                    </tr>
                {% endfor %}
                {% if not net.participants %}
                    <tr><td colspan="6" class="muted">No check-ins recorded.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</section>

<section class="card">
    <div class="card-header">
        <h3>Transcripts</h3>
        <span class="muted">All transcriptions captured for this net.</span>
    </div>
    {% if net.transcripts %}
        {% for tx in net.transcripts %}
            <article class="transcript">
                <header>
                    <strong>{{ tx.created_at }}</strong>
                    <span class="muted">{{ tx.backend }} • {{ '{:.0%}'.format(tx.confidence) if tx.confidence is not none else '—' }}</span>
                </header>
                <pre>{{ tx.text }}</pre>
            </article>
        {% endfor %}
    {% else %}
        <p class="muted">No transcripts have been attached to this net yet.</p>
    {% endif %}
</section>
{% endblock %}
